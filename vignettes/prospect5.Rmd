---
title: "5. Estimation with R or T only"
author: "Jean-Baptiste FÃ©ret, Florian de Boissieu"
date: "`r Sys.Date()`"
output:
  html_vignette:
    number_sections: true
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
vignette: >
  \usepackage[utf8]{inputenc}
  %\VignetteIndexEntry{5. Estimation with R or T only}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
```


# Prior estimation of n_struct
The `n_struct` structure parameter is usually estimated from the inversion of 
PROSPECT using reflectance and transmittance for spectral bands corresponding to 
minimum absorption, maximum reflectance, and maximum transmittance. 

[Qiu et al. (2018)](https://doi.org/10.1109/TGRS.2018.2791930 "Qiu et al., TGRS 2018") 
reported a strong correlation between the `n_struct` parameter and the ratio 
between reflectance and transmittance measured in the NIR at 800 nm. 
Taking advantage of this correlation to estimate `n_struct` requires measuring 
both leaf reflectance and transmittance, in line with the original method used 
to compute `n_struct` from leaf optical properties. 
However, absorptance in the NIR domain is usually very low: 
[Merzlyak et al. (2004)](https://doi.org/10.1016/j.jphotobiol.2004.03.003 "Merzlyak et al. (2004)") 
even suggest that absorptance in the domain ranging from 750 nm to 800 nm can 
be neglected. 
Thus assuming light in the NIR is primarily either reflected or transmitted as 
a function of leaf structure, information about reflectance only or 
transmittance only might be sufficient to accurately estimate the `n_struct` 
parameter with moderate uncertainty, following the hypothesis that absorptance 
is negligible. 

The estimation of `n_struct` prior to PROSPECT inversion may therefore lead to 
improved estimation of leaf constituents when using optimal spectral subdomains 
with only reflectance or transmittance.

Here, we assume that absorptance is negligible in specific spectral domains of 
the NIR. Therefore, the R/T ratio is equivalent to R/(1-R) and to (1-T)/T.
Then, we can adjust the `n_struct` ~ R/(1-R) and `n_struct` ~ (1-T)/T 
relationship based on simulations, and apply this linear relationship on 
experimental to get estimates of `n_struct` based on R only or T only. 

The function `get_N_prior` aims at adjusting this linear relationship, based on 
the work described in [Spafford et al. (2021)](https://doi.org/10.1016/j.rse.2020.112176).

This estimated `n_struct` value can then be used as prior information when 
inverting PROSPECT leaf chemical constituents.

```{r get prior estimate of n_struct}
# Libraries required 
library(prospect)
# download ANGERS dataset
lop_db <- download_leaf_db(db_name = 'ANGERS')
# Prior estimation of n_struct using R only
Nprior_R <- get_N_prior(lambda = lop_db$lambda, 
                        refl = lop_db$refl)
# Prior estimation of n_struct using T only
Nprior_T <- get_N_prior(lambda = lop_db$lambda, 
                        tran = lop_db$tran)
```

### Prior estimate of `n_struct` based on R or T only vs. 
`n_struct` estimate from iterative optimization over the full spectral domain
See https://jbferet.gitlab.io/prospect/articles/prospect3.html to get estimation 
of `n_struct` from inversion over the full spectral domain
The value of `n_struct` estimated from from either R or T is compared to 
`n_struct` based on iterative optimization over the full spectral domain on 
figure 1. 


<p float="left">
  <img src="../man/figures/N_RTvsR.png" width="33%" />
  <img src="../man/figures/N_RTvsT.png" width="33%" />
  <img src="../man/figures/N_RvsT.png" width="33%" />
</p>
<center>
  Fig. 1. Comparison between `n_struct` estimated from PROSPECT inversion using 
  R & T over the full spectral domain, and from PROSPECT inversion using either 
  R or T and the method provided in the function `get_N_prior`, for ANGERS dataset.
</center> 
<p>&nbsp;</p>


# PROSPECT inversion using prior estimation of `n_struct` and only R or only T

The estimation of leaf constituents based on reflectance or transmittance only, 
when no prior estimation of `n_struct` is provided, is performed as follows:

```{r Invert PROSPECT-D Full R or T only}
# Estimate all parameters for PROSPECT-D
parms_to_estimate  <- 'ALL'
init_values <- data.frame(chl = 40, car = 10, ant = 0.1, brown = 0, 
                          ewt = 0.01, lma = 0.01, n_struct = 1.5)
# Adjust spectral domain for SpecPROSPECT to fit leaf optical properties 
lop_subset <- fit_spectral_data(lambda = lop_db$lambda,
                                refl = lop_db$refl, 
                                tran = lop_db$tran)
print('prospect inversion using full spectral range')
options <- set_options_prospect(fun = 'invert_prospect')
options$spec_prospect <- lop_subset$spec_prospect
options$init_values <- init_values
res_Ronly <- invert_prospect(refl = lop_subset$refl, tran = NULL, 
                             prospect_version = 'D', 
                             parms_to_estimate = parms_to_estimate, 
                             options = options)

res_Tonly <- invert_prospect(refl = NULL, tran = lop_subset$tran, 
                             prospect_version = 'D',
                             parms_to_estimate = parms_to_estimate, 
                             options = options)
```

The performance of PROSPECT inversion when no prior estimation of `n_struct` is 
provided and only R and T measured can be compared with the performances 
obtained when prior estimate of `n_struct` is provided.

```{r Invert PROSPECT-D Full R or T only & prior n_struct}
# Estimate all parameters for PROSPECT-D
parms_to_estimate <- c("chl", "car", "ant", "ewt", "lma")
print('prospect inversion using full spectral range')
res_R_Nprior <- res_T_Nprior <- list()
for (i in 1:lop_db$nb_samples){
  print(i)
  init_values <- data.frame(chl = 40, car = 10, ant = 0.1, brown = 0, 
                            ewt = 0.01, lma = 0.01, 
                            n_struct = Nprior_R$n_struct[i])
  options <- set_options_prospect(fun = 'invert_prospect')
  options$spec_prospect <- lop_subset$spec_prospect
  options$init_values <- init_values
  res_R_Nprior[[i]] <- invert_prospect(refl = lop_subset$refl[[i]], 
                                       tran = NULL, 
                                       prospect_version = 'D',
                                       parms_to_estimate = parms_to_estimate, 
                                       options = options)
  
  init_values <- data.frame(chl = 40, car = 10, ant = 0.1, brown = 0, 
                           ewt = 0.01, lma = 0.01, n_struct = Nprior_T$n_struct[i])
  options$init_values <- init_values
  res_T_Nprior[[i]] <- invert_prospect(refl = NULL, 
                                       tran = lop_subset$tran[[i]], 
                                       prospect_version = 'D',
                                       parms_to_estimate = parms_to_estimate, 
                                       options = options)
}
```

Finally, the combination of prior estimation of `n_struct` and optimal spectral 
domain for each constituent is also tested:

```{r Invert PROSPECT-D Full R or T only & prior n_struct & optimal subdomain}
# Estimate all parameters for PROSPECT-D using R only
parms_to_estimate  <- c('chl','car','ant','ewt','lma')
init_values <- data.frame(chl = 40, car = 8, ant = 0.1, brown = 0, 
                          ewt = 0.01, lma = 0.01, n_struct = 1.5)
print('prospect inversion using optimal spectral setting and prior n_struct')
options <- set_options_prospect(fun = 'invert_prospect')
options$spec_prospect <- lop_subset$spec_prospect
options$init_values <- init_values
ParmEst_R_OPT <- invert_prospect_opt(lambda = lop_subset$lambda, 
                                     refl = lop_subset$refl, 
                                     tran = NULL, 
                                     prospect_version = 'D',
                                     parms_to_estimate = parms_to_estimate, 
                                     options = options)

ParmEst_T_OPT <- invert_prospect_opt(lambda = lop_subset$lambda, 
                                     refl = NULL, 
                                     tran = lop_subset$tran, 
                                     prospect_version = 'D',
                                     parms_to_estimate = parms_to_estimate, 
                                     options = options)
```

The comparison between PROSPECT inversion without prior `n_struct`, with prior 
`n_struct`, and with prior `n_struct` and optimal spectral domain selection, 
when only R or T are used, is showed below:

<p float="left">
  <img src="../man/figures/CHL_R.png" width="33%" />
  <img src="../man/figures/CHL_R_Nprior.png" width="33%" />
  <img src="../man/figures/CHL_R_Nprior_OPT.png" width="33%" />
</p>
<p float="left">
  <img src="../man/figures/CHL_T.png" width="33%" />
  <img src="../man/figures/CHL_T_Nprior.png" width="33%" />
  <img src="../man/figures/CHL_T_Nprior_OPT.png" width="33%" />
</p>
<center>
  Fig. 2. Estimation of `chl` from PROSPECT inversion, without prior `n_struct` 
  (left), with prior `n_struct` (middle), and with prior `n_struct` and optimal 
  spectral domain selection (right), when using only R (top) or only T (bottom). 
  Grey dots correspond to the estimation when inverting PROSPECT using  R & T 
  over the full VSWIR spectral domain. 
</center>
<p>&nbsp;</p>

<p float="left">
  <img src="../man/figures/CAR_R.png" width="33%" />
  <img src="../man/figures/CAR_R_Nprior.png" width="33%" />
  <img src="../man/figures/CAR_R_Nprior_OPT.png" width="33%" />
</p>
<p float="left">
  <img src="../man/figures/CAR_T.png" width="33%" />
  <img src="../man/figures/CAR_T_Nprior.png" width="33%" />
  <img src="../man/figures/CAR_T_Nprior_OPT.png" width="33%" />
</p>
<center>
  Fig. 3. Estimation of `car` from PROSPECT inversion, without prior `n_struct` 
  (left), with prior `n_struct` (middle), and with prior `n_struct` and optimal 
  spectral domain selection (right), when using only R (top) or only T (bottom). 
  Grey dots correspond to the estimation when inverting PROSPECT using  R & T 
  over the full VSWIR spectral domain.
</center>
<p>&nbsp;</p>

<p float="left">
  <img src="../man/figures/EWT_R.png" width="33%" />
  <img src="../man/figures/EWT_R_Nprior.png" width="33%" />
  <img src="../man/figures/EWT_R_Nprior_OPT.png" width="33%" />
</p>
<p float="left">
  <img src="../man/figures/EWT_T.png" width="33%" />
  <img src="../man/figures/EWT_T_Nprior.png" width="33%" />
  <img src="../man/figures/EWT_T_Nprior_OPT.png" width="33%" />
</p>
<center>
  Fig. 4. Estimation of `ewt` from PROSPECT inversion, without prior `n_struct` 
  (left), with prior `n_struct` (middle), and with prior `n_struct` and optimal 
  spectral domain selection (right), when using only R (top) or only T (bottom). 
  Grey dots correspond to the estimation when inverting PROSPECT using  R & T 
  over the full VSWIR spectral domain.
</center>
<p>&nbsp;</p>

<p float="left">
  <img src="../man/figures/LMA_R.png" width="33%" />
  <img src="../man/figures/LMA_R_Nprior.png" width="33%" />
  <img src="../man/figures/LMA_R_Nprior_OPT.png" width="33%" />
</p>
<p float="left">
  <img src="../man/figures/LMA_T.png" width="33%" />
  <img src="../man/figures/LMA_T_Nprior.png" width="33%" />
  <img src="../man/figures/LMA_T_Nprior_OPT.png" width="33%" />
</p>
<center>
  Fig. 5. Estimation of `lma` from PROSPECT inversion, without prior `n_struct` 
  (left), with prior `n_struct` (middle), and with prior `n_struct` and optimal 
  spectral domain selection (right), when using only R (top) or only T (bottom). 
  Grey dots correspond to the estimation when inverting PROSPECT using  R & T 
  over the full VSWIR spectral domain.
</center>
<p>&nbsp;</p>
